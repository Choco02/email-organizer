<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizador de emails</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 font-sans">
    <div class="max-w-4xl mx-auto p-6 mt-10">
        <!-- Tab buttons -->
        <div class="flex gap-4">
            <button id="tab-todos"
                class="py-2 px-4 text-lg font-medium rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300 transition-all duration-200 active:bg-blue-500 active:text-white">
                Todos <span id="todos-count" class="ml-2 text-sm text-gray-700"></span>
            </button>
            <button id="tab-produtivo"
                class="py-2 px-4 text-lg font-medium rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300 transition-all duration-200">
                Produtivo <span id="produtivo-count" class="ml-2 text-sm text-gray-700"></span>
            </button>
            <button id="tab-improdutivo"
                class="py-2 px-4 text-lg font-medium rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300 transition-all duration-200">
                Improdutivo <span id="improdutivo-count" class="ml-2 text-sm text-gray-700"></span>
            </button>

            <button id="openModalBtn"
                class="py-2 px-4 text-lg font-medium rounded-md text-gray-700 hover:bg-gray-300 ml-20 text-white bg-gradient-to-r from-blue-600 to-blue-500">
                Carregar emails
            </button>
        </div>

        <!-- Tab content -->
        <div id="tab-content" class="mt-6 p-6 bg-white rounded-lg shadow-md">
            <!-- Dynamic content will be injected here -->
        </div>
    </div>

    <!-- Modal -->
    <div class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50" id="modalOverlay">
        <div class="bg-white p-8 rounded-lg shadow-xl relative">
            <!-- Close Button -->
            <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800" id="closeModalBtn">&times;</button>

            <!-- Modal Content -->
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Analisar emails</h3>

            <!-- Textarea -->
            <textarea id="messageText"
                class="w-full p-4 border border-gray-300 rounded-md resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"
                rows="5" placeholder="Cole o conteúdo dos emails aqui ou envie um arquivo"></textarea>

            <!-- File Input -->
            <div id="fileEmailsInputContainer" class="border border-gray-300 rounded-md w-full p-4 text-center">
                <label for="fileEmailsInput" class="block text-gray-700">Arraste e solte um arquivo aqui ou clique para
                    escolher (PDF or .txt):</label>
                <input type="file" id="fileEmailsInput"
                    class="mt-2 w-full p-2 border border-gray-300 rounded-md text-sm text-gray-700 hidden"
                    accept=".pdf, .txt" />
                <p id="filenameInputEmails" class="mt-2 text-gray-600 hidden">Arquivo</p>
            </div>



            <!-- Submit Button -->
            <div class="mt-6 flex justify-end space-x-4">
                <button class="py-2 px-4 bg-gray-500 text-white rounded-md hover:bg-gray-600"
                    id="cancelBtn">Cancelar</button>
                <button
                    class="py-2 px-4 bg-blue-600 text-white rounded-md hover:scale-105 transform transition-transform transition-[scale] duration-150 disabled:bg-blue-800"
                    id="submitEmails">Enviar</button>
            </div>
        </div>
    </div>

    <script>
        // Sample address data with category classification (produtivo or improdutivo)
        const tabData = {
            todos: [],
            produtivo: [],
            improdutivo: []
        };

        function clearData() {
            tabData.todos = []
            tabData.produtivo = []
            tabData.improdutivo = []
        }

        // Get all tab buttons and content container
        const tabs = document.querySelectorAll('.py-2.px-4');
        const contentContainer = document.getElementById('tab-content');


        function formatSingleDate(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();

            // Check if the date is today
            if (date.toDateString() === today.toDateString()) {
                // Return HH:MM format for today
                const options = { hour: '2-digit', minute: '2-digit' };
                return new Intl.DateTimeFormat('pt-BR', options).format(date);
            } else {
                // Return DD/MM format for earlier days
                const options = { day: '2-digit', month: 'short' };
                return new Intl.DateTimeFormat('pt-BR', options).format(date);
            }
        }


        // Function to create an accordion item with reply and file input
        function createAccordionItem(data, renderCategoryLabel) {
            console.log(data)
            const accordionItem = document.createElement('div');
            accordionItem.classList.add('border-b', 'border-gray-300', 'my-2');

            // Create accordion header (clickable title)
            const accordionHeader = document.createElement('button');
            accordionHeader.classList.add('w-full', 'text-left', 'py-3', 'px-4', 'text-md', 'font-semibold', 'text-gray-800', 'hover:bg-gray-100', 'flex');

            const accordionHeaderUsername = document.createElement("p")
            const accordionHeaderSubject = document.createElement("p")
            const accordionHeaderDate = document.createElement("p")

            accordionHeaderUsername.textContent = data.username;
            accordionHeaderUsername.classList.add("w-40")
            accordionHeaderSubject.textContent = data.subject;
            accordionHeaderSubject.classList.add("grow")
            accordionHeaderDate.textContent = formatSingleDate(data.date);
            accordionHeaderDate.classList.add("w-20", "ml-2", "text-sm")

            const accountHeaderData = [accordionHeaderUsername, accordionHeaderSubject]

            accountHeaderData.forEach(i => accordionHeader.appendChild(i))


            // Add category label to all tabs (show in Todos, Produtivo, and Improdutivo)
            if (data.category && renderCategoryLabel) {
                const categoryLabel = document.createElement('span');
                categoryLabel.classList.add('ml-2', 'text-sm', 'py-1', 'px-2', 'rounded-full');

                // Assign color based on category
                if (data.category === "Produtivo") {
                    categoryLabel.classList.add('bg-green-200', 'text-green-800'); // Green for "Produtivo"
                    categoryLabel.textContent = "Produtivo";
                } else if (data.category === "Improdutivo") {
                    categoryLabel.classList.add('bg-red-200', 'text-red-800'); // Red for "Improdutivo"
                    categoryLabel.textContent = "Improdutivo";
                }

                accordionHeader.appendChild(categoryLabel);
            }

            accordionHeader.appendChild(accordionHeaderDate)
            accordionItem.appendChild(accordionHeader);

            // Create accordion content (hidden by default)
            const accordionContent = document.createElement('div');
            accordionContent.classList.add('accordion-content', 'h-0', 'overflow-hidden', 'transition-[height]', 'duration-300', 'px-4', 'py-2', 'text-gray-600');
            accordionContent.innerHTML = `<p class="mt-2"><strong>${data.address}</strong></br>${data.content}</p>`;
            accordionItem.appendChild(accordionContent);

            // Add event listener to toggle the content visibility
            accordionHeader.addEventListener('click', () => {
                accordionContent.classList.toggle('h-60')
                // Toggle the visibility of reply section
                replySection.classList.toggle('hidden');
            });

            // Create reply section with textarea and reply button
            const replySection = document.createElement('div');
            replySection.classList.add('mt-4', 'space-y-4', 'hidden'); // Initially hidden

            // Textarea for reply
            const replyTextarea = document.createElement('textarea');
            replyTextarea.classList.add('w-full', 'p-4', 'border', 'rounded-md', 'bg-gray-50', 'resize-none', 'focus:outline-none', 'focus:ring-2', 'focus:ring-blue-500');
            replyTextarea.rows = 4;
            replyTextarea.value = data.suggested_reply;
            replySection.appendChild(replyTextarea);

            // Attachment and Reply button in the same row
            const actionRow = document.createElement('div');
            actionRow.classList.add('flex', 'items-center', 'justify-between', 'space-x-4');

            // Attachment input (Drag and drop functionality)
            const fileInputContainer = document.createElement('div');
            fileInputContainer.classList.add('border', 'border-gray-300', 'rounded-md', 'w-full', 'p-4', 'text-center', 'cursor-pointer', 'transition-all', 'hover:bg-blue-50');

            // Visual feedback for dragging
            const fileInputLabel = document.createElement('span');
            fileInputLabel.textContent = "Arraste e solte um arquivo aqui ou clique para escolher";
            fileInputLabel.classList.add('text-gray-500', 'block', 'mb-2');

            // Hidden file input
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.classList.add('hidden');
            fileInputContainer.appendChild(fileInputLabel);
            fileInputContainer.appendChild(fileInput);

            // Create file name display
            const fileNameDisplay = document.createElement('div');
            fileNameDisplay.classList.add('mt-2', 'text-gray-600', 'text-sm');
            fileNameDisplay.classList.add('hidden');  // Initially hidden
            fileInputContainer.appendChild(fileNameDisplay);

            // Trigger click on file input when container is clicked
            fileInputContainer.addEventListener('click', () => {
                fileInput.click(); // This opens the file picker dialog
            });

            // Handle file input change event (triggered when user selects a file)
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    fileNameDisplay.textContent = file.name; // Display file name
                    fileNameDisplay.classList.remove('hidden'); // Make filename visible
                }
            });

            // Drag and drop events
            fileInputContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileInputContainer.classList.add('bg-blue-50'); // Highlight the area when dragging
            });

            fileInputContainer.addEventListener('dragleave', () => {
                fileInputContainer.classList.remove('bg-blue-50'); // Remove highlight when leaving
            });

            fileInputContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                fileInputContainer.classList.remove('bg-blue-50'); // Remove highlight after drop
                const files = e.dataTransfer.files; // Get the dropped files
                if (files.length > 0) {
                    fileInput.files = files; // Assign the files to the input
                    const file = files[0];
                    fileNameDisplay.textContent = file.name; // Display file name
                    fileNameDisplay.classList.remove('hidden'); // Make filename visible
                }
            });

            // Reply button
            const replyButton = document.createElement('button');
            replyButton.textContent = "Responder";
            replyButton.classList.add('py-2', 'px-4', 'bg-blue-500', 'text-white', 'rounded-md', 'hover:bg-blue-600', 'focus:outline-none', 'focus:ring-2', 'focus:ring-blue-500');

            // Add event listener to handle the reply button click
            replyButton.addEventListener('click', () => {
                // For now, just alert the reply content for demo
                alert(`Replying to ${data.username}: ${replyTextarea.value}`);
                // Clear the textarea after reply
                replyTextarea.value = '';
            });

            actionRow.appendChild(fileInputContainer);
            actionRow.appendChild(replyButton);

            replySection.appendChild(actionRow);
            accordionItem.appendChild(replySection);

            return accordionItem;
        }

        // Function to create tab content (filtering based on category)
        function createTabContent(tabId) {
            // Clear the content container before adding new content
            contentContainer.innerHTML = '';

            // Filter the tabData based on the selected tab
            let filteredItems;
            if (tabId === 'todos') {
                filteredItems = tabData.todos; // Show all items in the Todos tab
            } else {
                filteredItems = tabData[tabId].filter(item => item.category.toLowerCase() === tabId); // Filter based on category
            }

            // Create the accordions for each filtered item
            filteredItems.forEach(item => {
                const accordionItem = createAccordionItem(item, tabId === "todos");
                contentContainer.appendChild(accordionItem);
            });
        }

        // Function to update count next to each tab
        function updateTabCounts() {
            document.getElementById('todos-count').textContent = tabData.todos.length > 0 ? `(${tabData.todos.length})` : '';
            document.getElementById('produtivo-count').textContent = tabData.produtivo.length > 0 ? `(${tabData.produtivo.length})` : '';
            document.getElementById('improdutivo-count').textContent = tabData.improdutivo.length > 0 ? `(${tabData.improdutivo.length})` : '';
        }

        // Function to change tab content
        function changeTabContent(tabId) {
            // Remove 'active' class from all tabs
            [...tabs].filter(tab => tab.id.includes("tab")).forEach(tab => {
                tab.classList.remove('bg-blue-500', 'text-white');
                tab.children[0].classList.remove('text-white');
            });

            // Add 'active' class to the clicked tab
            const clickedTab = document.getElementById(`tab-${tabId}`);
            clickedTab.classList.add('bg-blue-500', 'text-white');
            clickedTab.children[0].classList.add('text-white')

            // Create content for the selected tab
            createTabContent(tabId);
        }

        // Add click event listener to each tab
        [...tabs].filter(tab => tab.id.includes("tab")).forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.id.replace('tab-', '');
                changeTabContent(tabId);
            });
        });

        // Initialize with "Todos" tab active and update the counts
        updateTabCounts();
        changeTabContent('todos');

        // Get elements
        const openModalBtn = document.getElementById('openModalBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalOverlay = document.getElementById('modalOverlay');
        const cancelBtn = document.getElementById('cancelBtn');
        const submitEmails = document.getElementById('submitEmails');
        const messageText = document.getElementById('messageText');
        const fileInput = document.getElementById('fileInput');
        const fileEmailsInput = document.getElementById("fileEmailsInput");
        const fileEmailsInputContainer = document.getElementById("fileEmailsInputContainer");

        fileEmailsInputContainer.addEventListener("click", () => {
            // fileEmailsInput.click();
        })

        fileEmailsInput.addEventListener("change", (e) => {
            const [file] = e.target.files
            console.log(e)
            console.log(file)
            if (file) {
                const filenameInputEmails = document.getElementById("filenameInputEmails")
                console.log(filenameInputEmails)
                filenameInputEmails.textContent = file.name;
                filenameInputEmails.classList.remove("hidden");
            }
        })

        fileEmailsInputContainer.addEventListener("dragover", e => {
            e.preventDefault()
            fileEmailsInputContainer.classList.add("bg-blue-50")
        })

        fileEmailsInputContainer.addEventListener("dragleave", () => {
            fileEmailsInputContainer.classList.remove("bg-blue-50")
        })

        fileEmailsInputContainer.addEventListener("drop", (e) => {
            e.preventDefault()
            fileEmailsInputContainer.classList.remove("bg-blue-50")

            const files = e.dataTransfer.files

            if (files.length > 0) {
                fileEmailsInput.files = files
                const [file] = files
                filenameInputEmails.textContent = file.name;
                filenameInputEmails.classList.remove("hidden")
            }
        })

        // Open the modal
        openModalBtn.addEventListener('click', function () {
            modalOverlay.classList.remove('hidden');
        });

        // Close the modal
        closeModalBtn.addEventListener('click', function () {
            modalOverlay.classList.add('hidden');
        });

        // Close modal when clicking outside of the modal content
        modalOverlay.addEventListener('click', function (event) {
            if (event.target === modalOverlay) {
                modalOverlay.classList.add('hidden');
            }
        });

        // Handle the cancel button click
        cancelBtn.addEventListener('click', function () {
            modalOverlay.classList.add('hidden');
        });

        // Handle the send button click
        submitEmails.addEventListener('click', async function (event) {
            // 1. Previne o comportamento padrão do form para não recarregar a página
            event.preventDefault();
            submitEmails.disabled = true

            const message = messageText.value.trim(); // .trim() remove espaços em branco extras
            const file = fileEmailsInput.files[0];

            // Cria um objeto FormData vazio para ser preenchido
            let formData = new FormData();

            // 2. Lógica para decidir o que enviar
            if (file) {
                // Cenário 1: Arquivo presente. Apenas adicione o arquivo ao FormData.
                console.log("Arquivo anexado. Ignorando a textarea.");
                formData.append('file', file);

                // Opcional: Adicionar a mensagem também se houver
                // formData.append('message', message);

                await sendData(formData);

            } else {
                // Cenário 2: Sem arquivo anexado. Verifique a textarea.
                if (message === '') {
                    // Cenário 2a: TextArea vazia.
                    console.log("Nenhum arquivo ou mensagem fornecida.");
                    alert('Por favor, forneça uma mensagem ou anexe um arquivo.');
                    // Não fazemos nada mais, apenas saímos da função.

                } else {
                    // Cenário 2b: TextArea com conteúdo.
                    console.log("Conteúdo na textarea. Criando Blob e enviando.");

                    // Cria um Blob com o conteúdo da textarea
                    const blob = new Blob([message], { type: 'text/plain' });

                    // Adiciona o Blob ao FormData com um nome de arquivo
                    formData.append('file', blob, 'conteudo.txt');

                    await sendData(formData);
                }
            }

            // Fecha o modal após o processamento, independentemente do resultado
            modalOverlay.classList.add('hidden');
        });

        // Função assíncrona para enviar o FormData
        async function sendData(formData) {
            clearData()
            // 1. Cria o controlador de aborto
            const controller = new AbortController();

            // 2. Define o tempo limite (timeout) para a requisição
            const timeout = 10000; // 10 segundos em milissegundos
            const timeoutId = setTimeout(() => {
                controller.abort();
            }, timeout);

            try {
                const response = await fetch('http://localhost:5000/upload', {
                    method: 'POST',
                    body: formData,
                    // 3. Associa o sinal do controlador à requisição fetch
                    signal: controller.signal,
                });

                // 4. Se a requisição for bem-sucedida, limpa o temporizador
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`Erro de rede: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('Sucesso!', result);
                tabData.todos = result.emails
                tabData.produtivo = result.emails.filter(i => i.category === "Produtivo");
                tabData.improdutivo = result.emails.filter(i => i.category === "Improdutivo");
                updateTabCounts()
                createTabContent('todos')
                alert('Dados enviados com sucesso!');

            } catch (error) {
                // 5. Trata o erro de cancelamento (timeout)
                if (error.name === 'AbortError') {
                    console.error('A requisição excedeu o tempo limite.');
                    alert('A requisição demorou muito para responder. Por favor, tente novamente.');
                } else {
                    console.error('Falha ao enviar:', error);
                    alert('Falha ao enviar os dados.');
                }

            } finally {
                // Garantir que o temporizador seja limpo em qualquer cenário
                clearTimeout(timeoutId);
                submitEmails.disabled = false
            }
        }
    </script>
</body>

</html>